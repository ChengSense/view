<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>index</title>
</head>

<body>
  <app>
    <div @each="item:i:list">
      @each(l:item){
        <div @click="alert(param1)">
          @when(i==1){
            <div id="{i}">{param1}</div>
          }.when(i==2){
            <div>{param2}</div>
          }.when{
            <div>{l}</div>
          }
        </div>
      }
    </div>
  </app>
</body>

</html>
<script type="text/javascript">
  let $lang = /<(?:[^"'>]|"[^"]*"|'[^']*')*>|(@each|@when|\.when)\s*\((.*)\)\s*\{|\.when\s*\{|\{([^\{\}]*)\}|\}/g;
  let $chen = /<.*>|(@each|@when|\.when)\s*\((.*)\)\s*\{|\.when\s*\{/;
  let $html = /<.*>/;
  let $whea = /@when/;
  let $whec = /\.when\s*\((.*)\)\s*\{|\.when\s*\{/;
  let $close = /^\}$|<\s*\/.*>/;
  let $attr = /\s*([^\s"'<>\/=]+)(?:\s*(=)\s*(?:"([^"]*)"+|'([^']*)'+|([^\s"'=<>`]+)))?/g
  let $eash = /(@each)\s*=\s*("([^"]*)"|'([^']*)')/;
  let $event = /(@.*)\s*=\s*("([^"]*)"|'([^']*)')/;
  let $id = /(@id)\s*=\s*("([^"]*)"|'([^']*)')/;
  let text = document.querySelector("app").outerHTML;
  text = text.replace($lang, tag => "###########".concat(tag.trim(), "###########"));
  let list = text.split("###########");

  function whiles(list, method, me) {
    while (list.length) {
      if (method(list.shift(), list))
        break;
    }
  }

  function initCompiler(list, children) {
    whiles(list, child => {
      if (child.trim() == "") return;
      if (new RegExp($close).test(child)) return true;
      let item = { clas: createNode(child), children: [] };
      children.push(item);
      if (new RegExp($html).test(child)) {
        if (new RegExp($close).test(item.clas.outerHTML)) {
          initCompiler(list, item.children);
        }
        if (new RegExp($eash).test(child)) {
          item.clas = createNode(child.replace($eash, child => {
            child = child.replace($eash, "@each($3){");
            let index = children.indexOf(item);
            let each = { clas: createNode(child), children: [item] };
            children.splice(index, 1, each);
            return "";
          }));
        }
      }
      else if (new RegExp($chen).test(child)) {
        initCompiler(list, item.children);
        if (new RegExp($whea).test(child)) {
          let index = children.indexOf(item);
          let when = { clas: createNode("@when{"), children: [item] };
          children.splice(index, 1, when);
        } else if (new RegExp($whec).test(child)) {
          let when = children[children.length - 2];
          when.children.push(children.pop());
        }
      }
    });
    return children;
  }

  function createNode(template) {
    if (new RegExp($html).test(template)) {
      let list = template.match($attr);
      let element = document.createElement(list.shift());
      list.forEach(attr => {
        try {
          let name = attr.replace($attr, "$1");
          let value = attr.replace($attr, "$3");
          element.setAttribute(name, value);
        } catch (error) {
          console.warn(error);
        }
      });
      return element;
    } else {
      let range = document.createRange();
      let element = range.createContextualFragment(template)
      return element.firstChild;
    }
  }

  let apps = initCompiler(list, []);
  console.log(apps);
  console.log(createNode(`<div @each="item:i:list">`));
  console.log(`<thead @each="item:i:list">`.match($eash));
</script>