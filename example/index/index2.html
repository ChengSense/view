<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>index</title>
</head>

<body>
  <app>
    <div @each="item:i:list">
      @each(l:item){
      <div @click="alert(param1)">
        @when(i==1){
        <div id="{i}">{param1}</div>
        }.when(i==2){
        <div>{param2}</div>
        }.when{
        <div>{l}</div>
        }
      </div>
      }
    </div>
  </app>
</body>

</html>
<script type="text/javascript">
  let $lang = /<(?:[^"'>]|"[^"]*"|'[^']*')*>|(@each|@when|\.when)\s*\((.*)\)\s*\{|\.when\s*\{|\{([^\{\}]*)\}|\}/g;
  let $chen = /<.*>|(@each|@when|\.when)\s*\((.*)\)\s*\{|\.when\s*\{/;
  let $each = /@each=("([^"]*)"|'([^']*)')/;
  let $whea = /@when/;
  let $whec = /\.when\s*\((.*)\)\s*\{|\.when\s*\{/;
  let $close = /^\}$|<\s*\/.*>/;
  let $attr = /\s*([^\s"'<>\/=]+)(?:\s*(=)\s*(?:"([^"]*)"+|'([^']*)'+|([^\s"'=<>`]+)))?/g
  let text = document.querySelector("app").outerHTML;
  text = text.replace($lang, tag => "###########".concat(tag.trim(), "###########"));
  let list = text.split("###########");

  function each(list, method, me) {
    while (list.length) {
      if (method(list.shift(), list))
        break;
    }
  }

  function preCompiler(list, children) {
    each(list, child => {
      if (child.trim() == "") return;
      if (new RegExp($close).test(child)) return true;
      let item = { clas: child, children: [], childNodes: [] };
      children.push(item);
      if (new RegExp($chen).test(child)) {
        preCompiler(list, item.children);
        if (new RegExp($each).test(child)) {
          item.clas = child.replace($each, child => {
            child = child.replace($each, "@each($2){");
            let index = children.indexOf(item);
            let each = { clas: child, children: [item], childNodes: [] };
            children.splice(index, 1, each);
            return "";
          });
        }
        else if (new RegExp($whea).test(child)) {
          let index = children.indexOf(item);
          let when = { clas: "@when{", children: [item], childNodes: [] };
          children.splice(index, 1, when);
        } else if (new RegExp($whec).test(child)) {
          let when = children[children.length - 2];
          when.children.push(children.pop());
        }
      }
    });
    return children;
  }

  function createNode(template) {
    if (new RegExp(/<.*>/).test(template)) {
      let list = template.match($attr);
      let element = document.createElement(list.shift());
      list.forEach(attr => {
        try {
          let name = attr.replace($attr, "$1");
          let value = attr.replace($attr, "$3");
          element.setAttribute(name, value);
        } catch (error) {
          console.warn(error);
        }
      });
      return element;
    } else {
      return document.createTextNode(template);
    }
  }

  let apps = preCompiler(list, []);
  console.log(apps);
  console.log(createNode(`<div @each="item:i:list">`));

</script>